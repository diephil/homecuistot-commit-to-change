# Research: Drizzle-Only Migrations

**Date**: 2026-01-26
**Feature**: 008-drizzle-migrations

## Decision 1: Migration Output Directory

**Decision**: `apps/nextjs/src/db/migrations`

**Rationale**: User-specified location. Keeps migrations colocated with schema definitions in `src/db/schema/`. Follows Drizzle's convention of keeping DB artifacts together.

**Alternatives Considered**:
- `drizzle/migrations` - Drizzle default, but separates from schema
- `supabase/migrations` - Current location, ties to Supabase CLI

## Decision 2: Migration Generation Command

**Decision**: Use `drizzle-kit generate` CLI command

**Rationale**: Drizzle Kit's codebase-first approach - schema is source of truth, generate diffs as SQL files.

**Configuration**:
```typescript
export default defineConfig({
  schema: './src/db/schema/index.ts',
  out: './src/db/migrations',
  dialect: 'postgresql',
  verbose: true, // Enable logging per user request
})
```

## Decision 3: Migration Application Method

**Decision**: Use `drizzle-kit migrate` CLI command + programmatic migration script

**Rationale**:
- CLI for local development: `npx drizzle-kit migrate`
- Programmatic script for production deployments with logging

**Implementation**: Create `src/db/migrate.ts` script that:
1. Connects to database via `DATABASE_URL_DIRECT`
2. Runs migrations with logging enabled
3. Can be invoked via npm script: `pnpm db:migrate`

## Decision 4: Existing Migration Reconciliation

**Decision**: Manually insert existing migration records into Drizzle's `__drizzle_migrations` table

**Rationale**: Local and production DBs already have schema applied via Supabase (2 migrations). Need to tell Drizzle those migrations are "already applied" without re-running them. **Data must be preserved.**

**Process**:
1. Copy existing SQL files from `supabase/migrations/` to new `src/db/migrations/` folder
2. Keep original Drizzle naming (already has correct format: `0000_striped_scarlet_witch.sql`)
3. Copy `meta/_journal.json` and `meta/0000_snapshot.json` to new location
4. Add entry for `0001_enable_rls_policies.sql` to journal
5. Create `__drizzle_migrations` table and insert records for both migrations
6. Delete old `supabase/migrations/` folder after verification

**Baseline Script** (`src/db/baseline.ts`):
```typescript
// Inserts records into __drizzle_migrations for already-applied migrations
// Run once per environment to establish baseline
```

## Decision 5: Migration Tracking Table

**Decision**: Use default `__drizzle_migrations` table in `public` schema

**Rationale**: Standard Drizzle convention, no need for customization.

**Configuration**:
```typescript
migrations: {
  table: '__drizzle_migrations',
  schema: 'public'
}
```

## Decision 6: Logging During Migrations

**Decision**: Enable verbose logging + custom migrate script with console output

**Rationale**: User explicitly requested logs to inspect what Drizzle does.

**Implementation**:
1. Set `verbose: true` in drizzle.config.ts for generate command
2. Create custom migrate script that logs each SQL statement
3. Add npm scripts for easy invocation

## Decision 7: Database Driver

**Decision**: Use `postgres` driver (already installed)

**Rationale**: Already using `postgres` package in project. Compatible with Drizzle ORM.

## npm Scripts

```json
{
  "db:generate": "drizzle-kit generate",
  "db:migrate": "tsx --env-file=.env.local src/db/migrate.ts",
  "db:migrate:prod": "tsx --env-file=.env.prod src/db/migrate.ts",
  "db:studio": "drizzle-kit studio"
}
```

## Environment Strategy

**Local** (can reset):
- Reset DB fresh
- Apply migrations from scratch via `pnpm db:migrate`
- Clean slate for development

**Production** (preserve data):
- Run baseline script to mark existing migrations as "already applied"
- Inserts records into `__drizzle_migrations` table
- Future migrations generated by Drizzle will start from idx 2
- No data loss, no re-running existing migrations

## Decision 8: Validation Migration

**Decision**: Replace PostgreSQL enums with indexed text columns as validation

**Rationale**:
- Tests the full migration workflow end-to-end
- Removes PostgreSQL-specific enum types for better portability
- Generates a real migration (0002) that exercises generate → apply flow
- Validates both local and production environments

**Enums to Replace**:
- `ingredient_category` → text + index
- `recipe_source` → text + index
- `ingredient_type` → text + index

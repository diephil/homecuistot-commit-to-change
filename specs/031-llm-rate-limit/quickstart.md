# Quickstart: LLM Rate Limiting

## Implementation Order

### Phase 1: Schema & Migration
1. Create `src/db/schema/llm-usage-log.ts` (Drizzle table definition)
2. Export from `src/db/schema/index.ts`
3. Run `pnpm db:generate` to create migration SQL
4. **Manual step**: Review generated migration, then `pnpm db:migrate`
5. **Manual step**: Add RLS policies via custom SQL migration
6. Verify with `pnpm db:status`

### Phase 2: Service Layer
7. Create `src/lib/services/usage-limit.ts` with `checkUsageLimit` and `logUsage`

### Phase 3: Route Integration
8. Migrate 6 routes from `withUser` → `withAuth`
9. Add `checkUsageLimit` + `logUsage` calls to all 8 routes

### Phase 4: Verification
10. Add `DAILY_LLM_LIMIT=100` to `.env.local` (optional, 100 is default)
11. Manual test: make LLM calls and verify logging
12. Manual test: verify 429 response at limit

## Environment Variables

```bash
# Optional — defaults to 100
DAILY_LLM_LIMIT=100
```

## Key Files

| File | Action |
|------|--------|
| `src/db/schema/llm-usage-log.ts` | New |
| `src/db/schema/index.ts` | Add export |
| `src/db/migrations/XXXX_*.sql` | Generated by `pnpm db:generate` |
| `src/db/migrations/XXXX_rls_llm_usage_log.sql` | Manual: RLS policies |
| `src/lib/services/usage-limit.ts` | New |
| `src/app/api/inventory/agent-proposal/route.ts` | Add 2 lines |
| `src/app/api/onboarding/process-text/route.ts` | Migrate wrapper + add 2 lines |
| `src/app/api/onboarding/process-voice/route.ts` | Migrate wrapper + add 2 lines |
| `src/app/api/onboarding/process-recipe/route.ts` | Migrate wrapper + add 2 lines |
| `src/app/api/onboarding/story/process-input/route.ts` | Migrate wrapper + add 2 lines |
| `src/app/api/recipes/agent-proposal/route.ts` | Add 2 lines |
| `src/app/api/recipes/process-text/route.ts` | Migrate wrapper + add 2 lines |
| `src/app/api/recipes/process-voice/route.ts` | Migrate wrapper + add 2 lines |
